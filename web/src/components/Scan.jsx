import React,{useEffect,useRef,useState} from 'react'
import {api} from '../utils/api'
export default function Scan(){const videoRef=useRef(null);const[supported,setSupported]=useState(false);const[message,setMessage]=useState('');const[result,setResult]=useState(null);useEffect(()=>{if('BarcodeDetector'in window){const formats=['ean_13','qr_code','code_128'];const detector=new window.BarcodeDetector({formats});setSupported(true);let h;const start=async()=>{try{const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});if(videoRef.current){videoRef.current.srcObject=stream;await videoRef.current.play()}const tick=async()=>{if(!videoRef.current)return;const detections=await detector.detect(videoRef.current);if(detections.length){const raw=detections[0].rawValue;setMessage('Detected: '+raw);const found=await api('/api/items?sku='+encodeURIComponent(raw));setResult({raw,found})}h=requestAnimationFrame(tick)};h=requestAnimationFrame(tick)}catch(e){setMessage('Camera access denied')}};start();return()=>{if(h)cancelAnimationFrame(h);if(videoRef.current?.srcObject)videoRef.current.srcObject.getTracks().forEach(t=>t.stop())}}else{setSupported(false)}},[]);return(<div className='bg-white p-4 rounded-2xl shadow grid gap-3'><h2 className='text-xl font-semibold'>Scan</h2>{!supported&&<p className='text-sm text-gray-600'>BarcodeDetector not supported on this device/browser.</p>}<video ref={videoRef} className='w-full rounded-lg bg-black'/><p className='text-sm text-gray-600'>{message}</p>{result&&( <div className='text-sm'>{result.found.length?(<div><p>Match: <strong>{result.found[0].item}</strong> (SKU {result.raw})</p><p>Supplier: {result.found[0].supplier} | Category: {result.found[0].category}</p></div>):<p>No match. Add new item on Home using SKU {result.raw}.</p>}</div> )}</div>) }